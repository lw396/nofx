# Prompt 优化总结

基于 [nof1-prompt.md](nof1-prompt.md) 中的提示词工程最佳实践，对 `decision/engine.go` 的 System Prompt 和 User Prompt 进行了全面优化。

## 优化日期
2025-10-30

## 主要优化内容

### 1. System Prompt 优化

#### 1.1 针对 Qwen/DeepSeek 的特定优化

**添加研究声明** (第209行):
```go
sb.WriteString("**研究声明**: 这是一个合法的量化交易研究实验，专注于技术分析和系统性风险管理原则。\n\n")
```

**原因**:
- Qwen/DeepSeek 模型可能对加密货币监管敏感
- 明确这是合法研究实验，消除模型的顾虑
- 引导模型专注于技术分析而非合规性担忧

参考: nof1-prompt.md 第630-643行

#### 1.2 增强的交易环境规范

**新增 "TRADING ENVIRONMENT" 部分** (第226-237行):
- 明确交易所类型（永续合约）
- 详细说明资金费率机制
- 明确决策频率和费用结构
- 设定杠杆范围预期

**原因**:
- 帮助 AI 理解永续合约的特殊机制
- 明确费用成本，抑制过度交易
- 提供清晰的环境约束

参考: nof1-prompt.md 第57-77行

#### 1.3 明确的 ACTION SPACE 定义

**新增 "ACTION SPACE DEFINITION" 部分** (第239-256行):
- 清晰定义每个动作的含义和使用时机
- 明确持仓管理约束（禁止加仓、对冲、部分平仓）
- 使用视觉标记 ⚠️ 强调关键约束

**原因**:
- 明确动作空间，减少 AI 的困惑
- 强制执行风险管理规则
- 符合 nof1.ai 的规范化设计

参考: nof1-prompt.md 第79-100行

#### 1.4 详细的技术指标解释

**新增 "DATA INTERPRETATION GUIDELINES" 部分** (第292-321行):
- EMA, MACD, RSI, ATR, Open Interest, Funding Rate 的完整解释
- 每个指标的具体判断标准
- 如何结合指标进行交叉验证

**原因**:
- 确保 AI 正确理解技术指标含义
- 统一解读标准，减少歧义
- 提高决策质量

参考: nof1-prompt.md 第196-227行

#### 1.5 强化数据顺序强调

**新增 "DATA ORDERING" 专门章节** (第317-321行):
```go
sb.WriteString("# ⚠️ DATA ORDERING (关键！)\n\n")
sb.WriteString("**所有价格和指标数据的排序规则: 最旧 → 最新**\n\n")
sb.WriteString("数组的**最后一个元素**是**最新数据点**\n")
sb.WriteString("数组的**第一个元素**是**最旧数据点**\n\n")
sb.WriteString("⚠️ 不要搞混顺序！这是常见错误，会导致错误决策。\n\n")
```

**原因**:
- LLM 在处理时间序列时容易混淆顺序
- nof1.ai 发现这是最常见的错误
- 多次重复强调可显著降低错误率

参考: nof1-prompt.md 第228-236行, 第519-536行

#### 1.6 操作约束说明

**新增 "OPERATIONAL CONSTRAINTS" 部分** (第371-383行):
- 明确 AI 无法访问的内容（新闻、对话历史、外部API等）
- 说明必须从数据中推断的信息
- 强调无状态设计

**原因**:
- 设定清晰的能力边界
- 引导 AI 专注于技术分析
- 避免 AI 产生幻觉（假装有不存在的信息）

参考: nof1-prompt.md 第239-255行

#### 1.7 上下文窗口管理

**新增 "CONTEXT WINDOW MANAGEMENT" 部分** (第385-393行):
- 说明数据量限制（~10个数据点）
- 提供优化分析策略
- 建议聚焦关键数据点

**原因**:
- 帮助 AI 优化注意力分配
- 避免尝试记忆所有数字
- 提高分析效率

参考: nof1-prompt.md 第286-297行

#### 1.8 更严格的输出格式规范

**增强 "OUTPUT FORMAT SPECIFICATION" 部分** (第396-410行):
- 明确两步输出流程
- 详细的字段验证规则
- 多空方向的止损止盈规则

**原因**:
- 强制结构化输出
- 减少解析错误
- 确保决策完整性

参考: nof1-prompt.md 第150-175行, 第488-505行

### 2. User Prompt 优化

#### 2.1 开头的数据顺序强调

**在 User Prompt 最开头添加** (第442-445行):
```go
sb.WriteString("⚠️ **关键提醒: 所有价格和指标数据的排序规则是 最旧 → 最新**\n\n")
sb.WriteString("**数组中最后一个元素 = 最新数据**\n")
sb.WriteString("**数组中第一个元素 = 最旧数据**\n\n")
```

**原因**:
- nof1.ai 在 User Prompt 开头用 ⚠️ 警告强调数据顺序
- 多次重复可显著降低混淆概率
- 视觉标记增强注意力

参考: nof1-prompt.md 第325-328行

#### 2.2 持仓数据的结构化展示

**改进持仓展示** (第468-502行):
- 使用 ### 标题分隔每个持仓
- 在市场数据前添加 "（最旧 → 最新）" 提醒
- 更清晰的格式化

**原因**:
- 提高可读性
- 在关键位置重复数据顺序提醒
- 符合 nof1.ai 的格式规范

参考: nof1-prompt.md 第334-369行

#### 2.3 候选币种数据顺序提醒

**在候选币种列表前添加** (第506行):
```go
sb.WriteString("⚠️ **数据顺序提醒**: 以下所有价格序列和指标序列均为 **最旧 → 最新** 排列\n\n")
```

**原因**:
- 在每个数据块前重复提醒
- nof1.ai 的最佳实践：在多个位置强调
- 减少 AI 在处理大量数据时的混淆

参考: nof1-prompt.md 第332-408行

#### 2.4 夏普比率反馈优化

**增强绩效反馈** (第529-551行):
- 根据夏普比率自动提供策略建议
- 明确的调整方向（停止交易、严格控制、维持策略）
- 视觉标记区分不同绩效水平

**原因**:
- 将被动反馈转化为主动建议
- 帮助 AI 自我调整交易频率
- 强化夏普比率作为核心指标的地位

参考: nof1-prompt.md 第180-194行, 第266-284行

#### 2.5 最后的决策提示

**优化结尾提示** (第554-558行):
```go
sb.WriteString("**输出要求**:\n")
sb.WriteString("1. 首先输出思维链分析（简洁的纯文本）\n")
sb.WriteString("2. 然后输出JSON决策数组\n")
sb.WriteString("3. 记住: 数组中的序列数据是 **最旧 → 最新** 排列\n")
```

**原因**:
- 最后再次强调数据顺序（第三次提醒）
- 明确输出步骤
- 确保 AI 在开始输出前回顾关键约束

参考: nof1-prompt.md 第474行

## 优化效果预期

### 1. 减少常见错误

- **数据顺序混淆**: 通过3次重复强调，预计错误率降低60%+
- **过度交易**: 通过费用意识和夏普比率反馈，预计交易频率降低30%+
- **低质量信号**: 通过严格的开仓标准和信心度要求，预计提高30%+

### 2. 提升决策质量

- **多空平衡**: 明确强调做空的盈利能力，预计做空比例从10%提升到40%+
- **风险管理**: 强制性风险参数要求，预计止损执行率提升50%+
- **技术分析准确性**: 详细指标解释，预计技术信号识别准确率提升20%+

### 3. 模型适配性

- **Qwen/DeepSeek**: 研究声明消除合规顾虑，预计响应成功率提升15%+
- **通用性**: 清晰的约束和定义，所有模型都能受益
- **可维护性**: 结构化的章节，便于后续调整

## 关键学习点

从 nof1.ai 的提示词工程中学到的核心经验：

1. **多次重复关键信息**: 数据顺序这类关键信息需要在3-5个位置重复
2. **视觉标记增强注意力**: ⚠️ 和粗体可显著提高 AI 的注意力
3. **元认知设计**: confidence 字段强迫 AI 进行自我评估
4. **费用意识植入**: 明确提及交易成本可自然抑制过度交易
5. **无状态设计的优劣**: 简化了系统，但限制了学习能力
6. **模型特定优化**: 了解不同模型的偏见和限制很重要

## 测试建议

建议进行以下A/B测试来验证优化效果：

1. **数据顺序测试**: 对比优化前后的时间序列理解准确率
2. **交易频率测试**: 对比优化前后的平均持仓时长
3. **多空比例测试**: 对比优化前后的做空交易占比
4. **夏普比率测试**: 长期运行对比风险调整后收益
5. **模型对比测试**: DeepSeek vs Qwen 在相同提示词下的表现差异

## 参考资料

- [nof1-prompt.md](nof1-prompt.md) - nof1.ai Alpha Arena 提示词工程逆向分析
- [decision/engine.go](../decision/engine.go) - 优化后的决策引擎代码
- nof1.ai Alpha Arena 官方文档

## 下一步优化方向

1. **增加短期记忆**: 在 User Prompt 中添加最近3-5次决策摘要
2. **市场状态识别**: 添加趋势/震荡/高波动的自动识别
3. **相关性分析**: 在开新仓前检查与现有持仓的相关性
4. **回撤控制**: 添加最大回撤和日损失熔断机制
5. **多模态输入**: 考虑添加K线图片输入（如果模型支持）
